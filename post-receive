#!/bin/bash
set -euo pipefail

# Log everything
exec > >(tee -a /home/www/deploy.log) 2>&1

echo "[deploy] Starting post-receive hook"

GIT_DIR="/home/www/repos/rezeptbuch.tobias-hopp.de.git"
WORK_TREE="/home/www/sites/rezeptbuch.tobias-hopp.de"
BRANCH="production"

# Checkout latest code for the target branch into work tree
/usr/bin/git --work-tree="$WORK_TREE" --git-dir="$GIT_DIR" checkout -f "$BRANCH"
cd "$WORK_TREE"

# Bootstrap nvm + Node 18 if available
export NVM_DIR="$HOME/.nvm"
if [ ! -s "$NVM_DIR/nvm.sh" ]; then
  echo "[deploy] Installing nvm..."
  curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash || true
fi
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
  nvm install 18 >/dev/null 2>&1 || true
  nvm use 18 >/dev/null 2>&1 || true
fi
export PATH="/usr/local/bin:/usr/bin:$PATH"

echo "[deploy] which node: $(which node || true)"
echo "[deploy] node -v : $(node -v || true)"
echo "[deploy] which npm : $(which npm || true)"
echo "[deploy] npm -v  : $(npm -v || true)"

# Run repo deploy script (composer + artisan + npm build)
bash scripts/deploy.sh

echo "[deploy] Finished post-receive hook"

